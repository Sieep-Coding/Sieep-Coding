name: Update Projects Table

on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 0 * * 0'

jobs:
  update-projects:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.x'

      - name: Install required dependencies
        run: |
          pip install requests jq

      - name: Fetch top 4 projects by stars and update table
        run: |
          username="Sieep-Coding"
          repos=$(curl -s "https://api.github.com/users/$username/repos?sort=stars&direction=desc" | jq -r '.[:5] | .[] | {name, stargazers_count, language, html_url} | "| \(.name) [\(.html_url)] | \(.stargazers_count) | \(.language) |"')

          project_data=""
          for repo in $(echo "$repos" | jq -r '.'); do
            project_data="$project_data$repo\n"
          done

          sed '/# Projects 🔍/q' README.md > README.tmp
          echo -e "\n# Projects 🔍\n\n| Projects | Stars ⭐ | Language |\n| --- | --- | --- |" >> README.tmp
          echo -e "$project_data" >> README.tmp
          tail -n +$(($(grep -n "# Projects 🔍" README.md | cut -d: -f1) + 1)) README.md >> README.tmp
          
          mv README.tmp README.md

      - name: Commit and push changes
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add README.md
          git commit -m "Update projects table"
          git push
